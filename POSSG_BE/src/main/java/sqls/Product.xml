<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="possg.com.a.dao.ProductDao">
		
<select id="productList" parameterType="possg.com.a.dto.ProductParam"
	resultType="possg.com.a.dto.ProductDto">
	select MIN(product_seq) AS product_seq, MIN(category_id) AS category_id
	, product_name, MIN(price) AS price
	, MIN(price_discount) AS price_discount
	, MAX(stock_quantity) AS stock_quantity,
		MAX(expiration_date) AS expiration_date
		, MAX(discount_rate) AS discount_rate
		, MIN(promotion_info) AS promotion_info
		, MAX(barcode) AS barcode, MAX(img_url) AS img_url
	from Product
	<where>
		<if test="choice != null and choice != '' and search != null and search != '' ">
			<if test="choice == 'product_name'">
				product_name like concat('%', #{search}, '%')
			</if>				
		</if>
		<if test="promotionInfo != null and promotionInfo != ''">
            and promotion_info = #{promotionInfo}
        </if>  
        <if test="categoryId != null and categoryId != ''">
            and category_id = #{categoryId}
        </if>

		<choose>
			<when test="minPrice >= 0 and maxPrice > 0">
				and price between #{minPrice} and #{maxPrice}
			</when>
			<when test="minPrice > maxPrice">
				and 1=0
			</when>
			<when test="minPrice >= 0 and maxPrice == 0">
	        and price >= #{minPrice}
	   		</when>
			<otherwise>
			</otherwise>
		</choose>
	</where>
	GROUP BY product_name
	order by 
		case when MAX(stock_quantity) = 0 then 1 else 0 end,
	<choose>
		<when test="sortOrder == 'leastExpiry'">
			expiration_date asc
		</when>
		<when test="sortOrder == 'mostExpiry'">
			expiration_date desc
		</when>
		<when test="sortOrder == 'lowestPrice'">
			price_discount asc
		</when>
		<when test="sortOrder == 'highestPrice'">
			price_discount desc
		</when>
		<when test="sortOrder == 'discountRate'">
			discount_rate desc
		</when>
		<otherwise>
			product_seq asc
		</otherwise>
	</choose>
	limit ${(pageNumber * 20)}, 20
</select>


<select id="getAllProduct" parameterType="possg.com.a.dto.ProductParam"
	resultType="java.lang.Integer">
	select count(*)
	from Product
	<where>
		<if test="choice != null and choice != '' and search != null and search != '' ">
			<if test="choice == 'product_name'">
				product_name like concat('%', #{search}, '%')
			</if>				
		</if>
		<if test="promotionInfo != null and promotionInfo != ''">
            and promotion_info = #{promotionInfo}
        </if>
        <if test="categoryId != null and categoryId != ''">
            and category_id = #{categoryId}
        </if>
		<choose>
			<when test="minPrice >= 0 and maxPrice > 0">
				and price between #{minPrice} and #{maxPrice}
			</when>
			<when test="minPrice > maxPrice">
				and 1=0
			</when>
			<when test="minPrice >= 0 and maxPrice == 0">
	        and price >= #{minPrice}
	   		</when>
			<otherwise>
			</otherwise>
		</choose>
	</where>
	order by 
		case when stock_quantity = 0 then 1 else 0 end,
	<choose>
		<when test="sortOrder == 'latest'">
			expiration_date desc
		</when>
		<when test="sortOrder == 'lowestPrice'">
			price_discount asc
		</when>
		<when test="sortOrder == 'highestPrice'">
			price_discount desc
		</when>
		<when test="sortOrder == 'discountRate'">
			discount_rate desc
		</when>
		<otherwise>
			product_seq asc
		</otherwise>
	</choose>
</select>

<select id="getLastProduct" resultType="Integer">
	select max(product_seq) from Product;
</select>

<insert id="productWrite" parameterType="possg.com.a.dto.ProductDto">
	insert into Product(category_id, product_name, price, price_discount, 
	stock_quantity, expiration_date, discount_rate, promotion_info, barcode, img_url)
	values(#{categoryId}, #{productName}, #{price}, #{priceDiscount}, 
			#{stockQuantity}, #{expirationDate}, #{discountRate}, 
			#{promotionInfo}, #{barcode}, #{imgUrl})
</insert>

<select id="productNameFind" parameterType="String" resultType="possg.com.a.dto.ProductDto">
    select(*) from Product where product_name = #{product_name}
</select>

<select id="getTotalStock" parameterType="String" resultType="int">
  select SUM(stock_quantity) from Product where product_name = #{productName}
</select>

<insert id="callProductConvAdd" parameterType="possg.com.a.dto.CallProductConvDto">
  insert into call_product_Conv (user_id, product_seq, amount, rp_name, b_name, price, call_date, product_name)
  values (#{userId}, #{productSeq}, #{amount}, #{rpName}, #{bName}, #{price}, #{callDate}, #{productName})
</insert>

</mapper>